# Registro de trabajo (encuesta multiling√ºe)

- Se configur√≥ la encuesta para soportar tres idiomas (castellano, euskera, ingl√©s) creando un archivo `app/static/questions.json` con todas las preguntas y opciones traducidas. Se a√±adi√≥ la pregunta ‚Äú¬øEres de √Ålava?‚Äù con salto condicional para omitir las preguntas locales si responde ‚ÄúNo‚Äù.
- Se reescribi√≥ `app/static/survey.js` para mostrar una pantalla inicial de selecci√≥n de idioma, cargar los pasos del idioma elegido, localizar textos de interfaz (botones, mensajes, progreso) y mantener la l√≥gica previa (multi chips, comentarios, validaciones y saltos).
- Se actualiz√≥ `app/templates/survey.html` para mostrar el selector de idioma (estilos, textos de cabecera) y dejar el cuerpo preparado para la l√≥gica din√°mica.
- El backend y el panel de moderaci√≥n ahora respetan todos los campos del payload:
  * `app/routers/admin.py` expone un endpoint `/api/admin/fields`, incluye metadatos (created_at, idioma) en `/pending` y genera exportaciones CSV con todas las columnas din√°micas.
  * `app/static/admin.js` y `app/templates/admin.html` renderizan las respuestas en tarjetas legibles mostrando cada campo con su etiqueta, adem√°s de usar el nuevo endpoint de campos para mantener el orden.
- Actualmente hay que levantar el servidor con `uvicorn app.main:app --reload`, probar los tres idiomas (incluyendo el salto condicional) y revisar en `/admin` que la moderaci√≥n muestra cada campo y que la exportaci√≥n CSV incluye todas las columnas.
- Se redise√±√≥ `/visual` con un mapa de fondo opcional (tecla M), c√≠rculos centrales por CP y nodos conectados por g√©nero (colores, tama√±os y animaci√≥n); el front (`app/static/visual_map.js` y `app/templates/visual.html`) ahora lee `/api/visual/points` para pintar cada g√©nero alrededor del c√≠rculo y escalar el tama√±o por n√∫mero de respuestas.
- Se refin√≥ la visualizaci√≥n radial: el c√≠rculo central ahora incluye el nombre y las conexiones salen desde su per√≠metro hacia nodos de g√©nero animados (movimiento lateral y vertical, tama√±os proporcionados), con la tecla M para alternar el mapa de fondo.
- Se refin√≥ la visualizaci√≥n radial: el c√≠rculo central ahora incluye el nombre, las conexiones salen del per√≠metro y los nodos de g√©nero se distribuyen con movimiento suave (tecla M sigue alternando el mapa).
- Se a√±adi√≥ un mazo de personajes bajo la leyenda del mapa: el backend (`/api/visual/points`) agrega las menciones de `personaje_importante`, expone los porcentajes y sirve las im√°genes de `app/images/personajes`, mientras que `visual.html`/`visual_map.js` renderizan una pila din√°mica que destaca temporalmente los datos de cada carta.
- La pila de personajes ocupa toda la columna izquierda, elimina fondos innecesarios, muestra cartas m√°s altas con los votos junto al nombre y a√±ade una animaci√≥n de plegado/despliegue cuando llega un nuevo personaje (los datos se ocultan comprimidos bajo la pantalla y luego reaparecen en su posici√≥n actualizada).
- Se cre√≥ la vista `/grid` (`app/templates/grid.html`) con fondo gris y malla 120x60 alineada al mapa `mapa_referencia.png` (tecla M para ocultar/mostrar). La cuadr√≠cula se adapta al viewport 16:9 y mantiene margen oculto.
- La capa de puntos en `/grid` pinta cada CP como par de celdas (conteo y g√©nero mayoritario con color). Los CP externos usan opacidad reducida, se posicionan por bearing/distancia de su provincia (centroides de Espa√±a) y no trazan l√≠neas.
- `/api/visual/points` a√±ade `latest_at` por CP y fallback para CP externos: calcula posici√≥n hacia el borde seg√∫n provincia. Exporta base_size 1920x1080 y la bandera `external`.
- Las 3 entradas m√°s recientes dibujan l√≠neas desde el cuadro de g√©nero al borde en direcciones alternadas (arriba/derecha/abajo/izquierda). Solo se trazan para CP internos.
- Se a√±adi√≥ `scripts/run_server.sh` para arrancar con el entorno Conda `server` y lanzar `uvicorn app.main:app --reload`.
- En `/grid` se a√±adi√≥ un bot√≥n de prueba de sonido y reproducci√≥n autom√°tica del blip al detectar nuevas respuestas (v√≠a aumento de total o `latest_at` m√°s reciente), respetando la habilitaci√≥n de audio del navegador (Safari requiere interacci√≥n previa).
- Timeline en `/grid`: cada ~10s se muestra un globo cuadrado, desplazado respecto al punto, con textos de campos de comentario (varios campos soportados) elegidos al azar por respuesta. Reproduce `blip2.mp3` al salir el globo y `blip.mp3` al detectarse nuevos puntos. Incluye logs en consola para depuraci√≥n de items/rotaci√≥n.
- Se restaur√≥ la nube de palabras en `/grid` (esquina superior izquierda) leyendo `asociaciones_alava`, escalando el tama√±o por frecuencia y con tooltip de menciones.
- Se elimin√≥ la l√≥gica de l√≠neas recientes para rehacerla: actualmente no se trazan l√≠neas; quedamos en un estado limpio para implementar la nueva versi√≥n.
- Pantalla final de encuesta: se elimin√≥ el check emoji, se a√±adi√≥ bloque de estad√≠sticas con donuts (valoraci√≥n, personaje, edades, g√©nero) localizados al idioma del cuestionario; tarjetas de tama√±o uniforme, leyendas debajo sin porcentajes, y campo de edad limitado a 1‚Äì99 en los tres idiomas.
- `/grid`: el zoom bubble de nuevas entradas usa el rojo principal; la palabra activa de la nube ahora hereda el verde `#a6c5bc`; los donuts de stats usan centro del color del globo; se a√±adi√≥ donut fijo de valoraci√≥n global en la esquina superior derecha con margen de celdas.
- Globo de personaje en `/grid`: ahora incluye donut de votos del personaje, contador/porcentaje, y bot√≥n ‚Äúüé≠ Probar personaje‚Äù en la UI para forzar su visualizaci√≥n si hay datos.
